<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Patient Portal | MediTriage AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
--bg:#0a192f;
--primary:#00d2ff;
--glass:rgba(255,255,255,0.03);
--low:#00e676;
--medium:#ffa500;
--high:#ff4d4d;
--text-dim:#94a3b8;
}
body{
margin:0;
font-family:'Plus Jakarta Sans',sans-serif;
background:linear-gradient(to bottom,rgba(10,25,47,0.95),rgba(10,25,47,0.98));
color:white;
}
.header{
padding:25px 6%;
display:flex;
justify-content:space-between;
align-items:center;
background:rgba(10,25,47,0.9);
border-bottom:1px solid rgba(255,255,255,0.1);
}
.container{
padding:40px 6%;
max-width:1400px;
margin:auto;
}
.card{
background:var(--glass);
backdrop-filter:blur(20px);
padding:30px;
border-radius:25px;
border:1px solid rgba(255,255,255,0.08);
margin-bottom:30px;
}
.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
gap:25px;
}
.btn{
background:var(--primary);
color:#0a192f;
padding:12px 18px;
border-radius:10px;
font-weight:700;
cursor:pointer;
border:none;
}
.risk-low{color:var(--low);}
.risk-medium{color:var(--medium);}
.risk-high{color:var(--high);}
.sos{
position:fixed;
top:20px;
right:20px;
background:red;
color:white;
padding:10px 20px;
border-radius:30px;
font-weight:800;
cursor:pointer;
}
/* ===== AI CHAT ASSISTANT ===== */

        #chat-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #00d2ff;
            color: #0a192f;
            padding: 14px 24px;
            border-radius: 50px;
            border: none;
            font-weight: 800;
            cursor: pointer;
            z-index: 9999;
        }

        #chatbox {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 20px;
            border: 1px solid #00d2ff;
            display: flex;
            flex-direction: column;
            overflow: visible;
            z-index: 9998;
        }

        .hidden {
            display: none !important;
        }

        .chat-header {
            padding: 15px;
            background: rgba(0,210,255,0.1);
        }

        .chat-disclaimer {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 8px;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-input {
            padding: 10px;
            display: flex;
            gap: 8px;
            background: rgba(255,255,255,0.05);
        }

        .chat-input input {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: white;
        }

        .chat-input button {
            background: #00d2ff;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            margin-bottom: 12px;
            border-radius: 15px;
            font-size: 14px;
        }

        .chat-bubble.user {
            background: #00d2ff;
            color: #0a192f;
            margin-left: auto;
        }

        .chat-bubble.ai {
            background: rgba(255,255,255,0.08);
            color: white;
            margin-right: auto;
        }

        #mic-btn.listening {
            background: white;
            color: #0a192f;
        }
        /* Fix dropdown options visibility */
        select option {
            color: black;
            background: white;
        }
        .container {
            padding: 50px 8%;
            max-width: 1600px;
            margin: auto;
        }

        .card {
            background: rgba(255,255,255,0.04);
            backdrop-filter: blur(25px);
            padding: 40px;
            border-radius: 28px;
            border: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            transition: 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: #00d2ff;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        @media(max-width: 900px){
            .grid {
                grid-template-columns: 1fr;
            }
        }

        h3 {
            margin-bottom: 25px;
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: 1px;
            color: #00d2ff;
        }

        canvas {
            height: 300px !important;
        }
        /* =========================
        ‚ú® BEAUTIFUL CHAT DROPDOWNS
        ========================= */

        .chat-header select {
            background: rgba(255, 255, 255, 0.08);
            color: #00d2ff;
            border: 1px solid rgba(0, 210, 255, 0.5);
            border-radius: 10px;
            padding: 8px 30px 8px 12px;
            font-weight: 600;
            font-size: 13px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            position: relative;
        }

        /* Hover effect */
        .chat-header select:hover {
            border-color: #00d2ff;
            box-shadow: 0 0 10px rgba(0,210,255,0.4);
        }

        /* Focus glow */
        .chat-header select:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(0,210,255,0.7);
        }

        /* Dropdown options */
        .chat-header select option {
            background: #0f172a;
            color: white;
        }

        /* Add arrow icon */
        .chat-header {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .appointment-card {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #94a3b8;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .form-group select option {
            color: black;
        }
</style>
</head>
<body>

<div class="header">
<h2>ü©∫ Patient Intelligence Dashboard</h2>
<div>
Welcome, <strong>{{ user_name }}</strong>
<a href="/upload" class="action-btn btn-upload">üìÅ Upload Doc</a>
<a href="/logout"><button class="btn">Logout</button></a>
</div>
</div>
<button class="sos" onclick="alert('üö® Call Emergency Services Immediately!')">üö® SOS</button>

<div class="container">

<!-- ========================= -->
<!-- 1Ô∏è‚É£ PERSONAL OVERVIEW -->
<!-- ========================= -->

<div class="card">
<h3>üë§ Personal Health Overview</h3>
<div class="grid">
<div>
<p><strong>Name:</strong> {{ user_name }}</p>
<p><strong>Patient ID:</strong> {{ patient.patient_id if patient else "N/A" }}</p>
<p><strong>Latest Risk:</strong> {{ patient.risk_level if patient else "No Data" }}</p>
<p><strong>Department:</strong> {{ patient.department if patient else "Not Assigned" }}</p>
</div>
<div>
<p><b>Latest Risk:</b>
<span class="
{% if patient.risk_level == 'Low' %}risk-low
{% elif patient.risk_level == 'Medium' %}risk-medium
{% else %}risk-high{% endif %}
">
{{ patient.risk_level }}
</span>
</p>
<p><b>Last Visit:</b> Recent</p>
</div>
</div>
</div>
<!-- ========================= -->
<!-- üìÇ TRIAGE HISTORY SECTION -->
<!-- ========================= -->

<div class="card" style="margin-top:40px;">
    <h3 style="margin-bottom:20px;">üìÇ Triage History</h3>

    {% if triage_history %}

        {% for case in triage_history %}

        <div style="background: rgba(255,255,255,0.03);
                    padding:20px;
                    border-radius:15px;
                    margin-bottom:15px;">

            <!-- Risk Badge -->
            {% if case.risk_level == "Low" %}
                <span class="risk-badge low">Low Risk</span>
            {% elif case.risk_level == "Medium" %}
                <span class="risk-badge medium">Medium Risk</span>
            {% else %}
                <span class="risk-badge high">High Risk</span>
            {% endif %}

            <h4>Case ID: {{ case.patient_id }}</h4>

            <p><strong>Department:</strong> {{ case.department }}</p>
            <p><strong>Symptoms:</strong> {{ case.symptoms }}</p>

            <div style="display:flex; gap:15px; margin-top:10px;">
                <div>BP: {{ case.bp }}</div>
                <div>HR: {{ case.hr }}</div>
                <div>Temp: {{ case.temp }}¬∞C</div>
            </div>

            <!-- View Report Button -->
            <a href="/view_report/{{ case.patient_id }}"
               class="btn primary-btn"
               style="margin-top:15px; max-width:200px;">
               View Report
            </a>

        </div>

        {% endfor %}

    {% else %}

        <p style="color:#94a3b8;">No triage records found.</p>

    {% endif %}

    <!-- üî• NEW TRIAGE BUTTON -->
    <a href="/triage"
       class="btn primary-btn"
       style="margin-top:25px; max-width:250px;">
       ‚ûï Start New Triage
    </a>

</div>
<!-- ========================= -->
<!-- 4Ô∏è‚É£ APPOINTMENTS -->
<!-- ========================= -->
<div class="card appointment-card">

    <h3>üìÖ Book Appointment</h3>

    <form action="/book_appointment" method="POST">

        <div class="form-group">
            <label>Select Hospital</label>
            <select name="hospital_id" required>
                <option value="">-- Choose Hospital --</option>

                {% for hospital in hospitals %}
                    <option value="{{ hospital.id }}">
                    {{ hospital.name }} |
                    üìç {{ hospital.location }} |
                    üè• {{ hospital.departments | join(', ') }} |
                    üöë {{ hospital.distance_km }} km
                    </option>
                {% endfor %}
                </select>
        </div>

        <div class="form-group">
            <label>Select Date</label>
            <input type="date" name="date" required>
        </div>

        <button type="submit" class="primary-btn">
            üöÄ Confirm Booking
        </button>

    </form>

</div>
<div class="dashboard-card">
    <h3>üìÖ My Appointments</h3>

    {% if appointments %}
        {% for appt in appointments %}
            <div class="appointment-item">
                <p><strong>üè• {{ appt.hospital_name }}</strong></p>
                <p>üìç {{ appt.hospital_location }}</p>
                <p>üìÜ {{ appt.appointment_date }}</p>

                <p>
                    {% if appt.status == "Pending" %}
                        <span class="status pending">üü° Pending</span>
                    {% elif appt.status == "Confirmed" %}
                        <span class="status confirmed">üü¢ Confirmed</span>
                    {% elif appt.status == "Rejected" %}
                        <span class="status rejected">üî¥ Rejected</span>
                    {% endif %}
                </p>
                <hr>
            </div>
        {% endfor %}
    {% else %}
        <p>No Appointments Booked Yet</p>
    {% endif %}

</div>
<!-- ========================= -->
<!-- 5Ô∏è‚É£ HOSPITAL NAVIGATION -->
<!-- ========================= -->
<div class="card">
    <h3>üöë Recommended Hospital</h3>

    {% if hospitals %}
        <h4>{{ hospitals[0].name }}</h4>
        <p>Distance: {{ hospitals[0].distance }} km</p>

        <a target="_blank"
           href="https://www.google.com/maps/dir/?api=1&destination={{ hospitals[0].name }}"
           class="btn primary-btn">
           Navigate Now
        </a>
    {% endif %}
</div>
<script>
    function findHospital(){
        navigator.geolocation.getCurrentPosition(pos=>{
        fetch("/find_hospitals",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                lat:pos.coords.latitude,
                lng:pos.coords.longitude,
            department:"{{ patient.department }}",
            risk_level:"{{ patient.risk_level }}"
        })
    })
    .then(res=>res.json())
    .then(data=>{
    if(data.length>0){
    const h=data[0];
    document.getElementById("hospital-result").innerHTML=
    `üè• ${h.name}<br>
    üìç ${h.distance} km<br>
    üõè ICU Beds: ${h.icu_beds}<br>
    <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${h.lat},${h.lng}">Navigate Now</a>`;
    }
    });
    });
    }

    /* RISK GRAPH */
    new Chart(document.getElementById("riskChart"),{
type:"line",
data:{
labels:[{% for record in history %}"{{ record.date }}",{% endfor %}],
datasets:[{
label:"Risk Severity",
data:[{% for record in history %}
{% if record.risk_level=="High" %}3
{% elif record.risk_level=="Medium" %}2
{% else %}1{% endif %},
{% endfor %}],
borderColor:"#00d2ff",
backgroundColor:"rgba(0,210,255,0.2)",
tension:0.4,
fill:true,
pointRadius:6
}]
},
options:{
responsive:true,
plugins:{
legend:{labels:{color:"white"}}
},
scales:{
y:{
ticks:{color:"white"},
grid:{color:"rgba(255,255,255,0.1)"},
min:0,
max:3
},
x:{
ticks:{color:"white"},
grid:{color:"rgba(255,255,255,0.05)"}
}
}
}
});
</script>
<button id="chat-toggle">ü§ñ AI Assistant</button>

<div id="chatbox" class="hidden">

    <div class="chat-header">
        <select id="chat-role">
            <option value="triage">Triage Mode</option>
            <option value="support">Patient Support</option>
            <option value="doctor">Doctor Assistant</option>
        </select>

        <select id="chat-language">
            <option value="en-US">English</option>
            <option value="hi-IN">Hindi</option>
            <option value="te-IN">Telugu</option>
            <option value="ta-IN">Tamil</option>
            <option value="kn-IN">Kannada</option>
        </select>
    </div>

    <div id="chat-messages"></div>

    <div class="chat-input">
        <button id="mic-btn">üé§</button>
        <input type="text" id="chat-input-field" placeholder="Type message..." />
        <button id="send-btn">Send</button>
    </div>

</div>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const toggleBtn = document.getElementById("chat-toggle");
    const chatBox = document.getElementById("chatbox");
    const chatMessages = document.getElementById("chat-messages");
    const userInput = document.getElementById("chat-input-field");
    const sendBtn = document.getElementById("send-btn");
    const micBtn = document.getElementById("mic-btn");
    const roleSelect = document.getElementById("chat-role");
    const languageSelect = document.getElementById("chat-language");

    toggleBtn.addEventListener("click", () => {
        chatBox.classList.toggle("hidden");
    });

    function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        chatMessages.innerHTML += `
            <div class="chat-bubble user">${message}</div>
        `;

        userInput.value = "";
        chatMessages.scrollTop = chatMessages.scrollHeight;

        fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                message: message,
                role: roleSelect.value,
                language: languageSelect.value
            })
        })
        .then(res => res.json())
        .then(data => {

            chatMessages.innerHTML += `
                <div class="chat-bubble ai">${data.reply}</div>
            `;

            chatMessages.scrollTop = chatMessages.scrollHeight;

            const speech = new SpeechSynthesisUtterance(data.reply);
            speech.lang = languageSelect.value;
            window.speechSynthesis.speak(speech);
        });
    }

    sendBtn.addEventListener("click", sendMessage);

    userInput.addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
            sendMessage();
        }
    });

    // üé§ Voice Recognition
    if ('webkitSpeechRecognition' in window) {

        const recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;

        micBtn.addEventListener("click", () => {
            recognition.lang = languageSelect.value;
            recognition.start();
            micBtn.classList.add("listening");
        });

        recognition.onresult = function(event) {
            userInput.value = event.results[0][0].transcript;
            micBtn.classList.remove("listening");
        };

        recognition.onend = function() {
            micBtn.classList.remove("listening");
        };

    } else {
        micBtn.style.display = "none";
    }

});
</script>
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {

    const canvas = document.getElementById('myChart');

    if (canvas) {
        const ctx = canvas.getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Low', 'Medium', 'High'],
                datasets: [{
                    label: 'Risk Levels',
                    data: [1, 2, 3]
                }]
            }
        });
    }

});
</script>
</body>
</html>